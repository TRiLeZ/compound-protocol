#!/usr/bin/env -S yarn repl -s

PrintTransactionLogs

-- Token holder addresses for mocking
Alias CompHolder "0x7587caefc8096f5f40acb83a09df031a018c66ec"
Alias TokenHolder "0x05e793ce0c6027323ac150f6d45c2344d28b6019"
Alias CUSDCHolder "0x5e34bc93a7506ecc8562ade4d5c8b090247a6349"

Web3Fork "https://mainnet-eth.compound.finance/@12960100" (CompHolder TokenHolder CUSDCHolder)
UseConfigs mainnet

-- Mint test
From TokenHolder (Erc20 MKR Approve (Address cMKR) 1000e18)
From TokenHolder (CToken cMKR Mint 1000e18)
Assert Equal (Erc20 MKR TokenBalance cMKR) (1000e18)

Comptroller ClaimComp TokenHolder
Assert Equal (Erc20 COMP TokenBalance TokenHolder) (0)

-- Begin deploy of debuggable Comptroller

MineBlock

ComptrollerImpl Deploy Standard ComptrollerG8

-- Propose to apply the patch

From CompHolder (Comp Delegate CompHolder)
From CompHolder (GovernorBravo GovernorBravoDelegator Propose "Upgrade to debug Comptroller" [(Address Unitroller) (Address ComptrollerG8)] [0 0] ["_setPendingImplementation(address)" "_become(address)"] [[(Address ComptrollerG8)] [(Address Unitroller)]])

-- Vote for, queue, and execute the proposal

MineBlock
AdvanceBlocks 14000
From CompHolder (GovernorBravo GovernorBravoDelegator Proposal LastProposal Vote For)
AdvanceBlocks 20000
GovernorBravo GovernorBravoDelegator Proposal LastProposal Queue
IncreaseTime 604910
GovernorBravo GovernorBravoDelegator Proposal LastProposal Execute
ComptrollerImpl ComptrollerG8 MergeABI
MineBlock

Assert Equal (Address (Unitroller Implementation)) (Address ComptrollerG8)

-- End deploy of debuggable Comptroller

-- Fast forward to make us accrue a ton of interest (1 year)
MineBlock
AdvanceBlocks 2354250

-- Delegate and propose COMP speed update
From CompHolder (Comp Delegate CompHolder)
From CompHolder (GovernorBravo GovernorBravoDelegator Propose "Exploit rewards bug" [(Address Comptroller)] [0] ["_setCompSpeed(address,uint256)"] [[(address cMKR) 1]])

-- Fast forward, vote, queue, execute
MineBlock
AdvanceBlocks 14000
From CompHolder (GovernorBravo GovernorBravoDelegator Proposal LastProposal Vote For)
AdvanceBlocks 20000
GovernorBravo GovernorBravoDelegator Proposal LastProposal Queue
IncreaseTime 604910
GovernorBravo GovernorBravoDelegator Proposal LastProposal Execute

-- Ensure accrue interest
CToken cMKR AccrueInterest

From TokenHolder (Erc20 MKR Approve (Address cMKR) 1000e18)
From TokenHolder (CToken cMKR Mint 1000e18)

Comptroller ClaimComp TokenHolder
Assert Equal (Erc20 COMP TokenBalance TokenHolder) (4)

-- Delegate and propose COMP speed update
From CompHolder (Comp Delegate CompHolder)
From CompHolder (GovernorBravo GovernorBravoDelegator Propose "Exploit rewards bug 1" [(Address Comptroller)] [0] ["_setCompSpeed(address,uint256)"] [[(address cMKR) 0]])

-- Fast forward, vote, queue, execute
MineBlock
AdvanceBlocks 14000
From CompHolder (GovernorBravo GovernorBravoDelegator Proposal LastProposal Vote For)
AdvanceBlocks 20000
GovernorBravo GovernorBravoDelegator Proposal LastProposal Queue
IncreaseTime 604910
GovernorBravo GovernorBravoDelegator Proposal LastProposal Execute

CToken cMKR AccrueInterest
Comptroller ClaimComp TokenHolder
Assert Equal (Erc20 COMP TokenBalance TokenHolder) (34013)

-- Fast forward to make us accrue a ton of interest (1 year)
MineBlock
AdvanceBlocks 2354250

-- Delegate and propose COMP speed update
From CompHolder (Comp Delegate CompHolder)
From CompHolder (GovernorBravo GovernorBravoDelegator Propose "Exploit rewards bug 2" [(Address Comptroller)] [0] ["_setCompSpeed(address,uint256)"] [[(address cMKR) 1]])

-- Fast forward, vote, queue, execute
MineBlock
AdvanceBlocks 14000
From CompHolder (GovernorBravo GovernorBravoDelegator Proposal LastProposal Vote For)
AdvanceBlocks 20000
GovernorBravo GovernorBravoDelegator Proposal LastProposal Queue
IncreaseTime 604910
GovernorBravo GovernorBravoDelegator Proposal LastProposal Execute

-- Ensure accrue interest
CToken cMKR AccrueInterest

From TokenHolder (Erc20 MKR Approve (Address cMKR) 1000e18)
From TokenHolder (CToken cMKR Mint 1000e18)

Comptroller ClaimComp TokenHolder
Assert Equal (Erc20 COMP TokenBalance TokenHolder) (34016)

Print "COMP rewards bug fix passed"